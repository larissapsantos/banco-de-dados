<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Painel da Coordenação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm" style="background-color: #6f42c1;">
    <div class="container-fluid px-5">
      <a class="navbar-brand fw-bold" href="#">Coordenação - Maker Central</a>
      <div class="d-flex align-items-center">
        <div class="text-white text-end me-3" style="line-height: 1.2;">
            <div class="fw-bold fs-5" id="saudacaoNome">Olá!</div>
            <small class="opacity-75" id="saudacaoInfo">Carregando...</small>
        </div>
        <button id="btnSair" class="btn btn-outline-light btn-sm">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    
    <div class="row mb-5">
      <div class="col-md-4 mb-4">
        <div class="card text-center border-secondary h-100">
          <div class="card-body">
            <h2 id="numPlanosRecebidos" class="display-5 fw-bold" style="color: #6f42c1;">0</h2>
            <p class="mb-0">Novos Planos (Profs)</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card text-center border-warning h-100">
          <div class="card-body">
            <h2 id="numEnviados" class="text-warning display-5 fw-bold">0</h2>
            <p class="mb-0">Enviados (Aguardando Admin)</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card text-center border-success h-100">
          <div class="card-body">
            <h2 id="numAprovados" class="text-success display-5 fw-bold">0</h2>
            <p class="mb-0">Solicitações Aprovadas</p>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-secondary">Gestão Escolar</h4>
        <button class="btn text-white" style="background-color: #6f42c1;" onclick="consolidarPedidos()">
            Enviar Selecionados para Admin
        </button>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-bottom-0 pt-3 px-4">
        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
          <li class="nav-item">
            <button class="nav-link active text-dark fw-bold" id="planos-tab" data-bs-toggle="tab" data-bs-target="#planos-pane" type="button">
                Planos Recebidos
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link text-secondary" id="solic-tab" data-bs-toggle="tab" data-bs-target="#solic-pane" type="button">
                Histórico
            </button>
          </li>
        </ul>
      </div>

      <div class="card-body p-0">
        <div class="tab-content" id="myTabContent">
          
          <div class="tab-pane fade show active" id="planos-pane">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th class="ps-4">Detalhes do Plano</th>
                        <th>ID</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Ação</th>
                      </tr>
                    </thead>
                    <tbody id="tabelaPlanos"></tbody>
                </table>
                <div id="msgSemPlanos" class="text-center p-4 text-muted" style="display:none;">
                    Nenhum plano novo recebido.
                </div>
            </div>
          </div>

          <div class="tab-pane fade" id="solic-pane">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Detalhes do Plano</th>
                            <th>Status Admin</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistorico"></tbody>
                </table>
                <div id="msgSemHistorico" class="text-center p-5 text-muted" style="display:none;">
                    Nenhuma solicitação enviada anteriormente.
                </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const matricula = sessionStorage.getItem("maker_matricula");
    const nome = sessionStorage.getItem("maker_nome") || "Coordenador";
    const perfil = sessionStorage.getItem("maker_perfil");

    if (!matricula || perfil !== "COORDENADOR") {
        window.location.href = "login_coordenador.html";
    } else {
        document.getElementById("saudacaoNome").innerText = `Olá, ${nome}!`;
        document.getElementById("saudacaoInfo").innerText = `Coordenador - Matrícula: ${matricula}`;
    }

    document.getElementById("btnSair").addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "index.html";
    });

    const API_URL = "http://localhost:8000/requisicao";
    
    let planosDaEscola = [];
    let selecionados = new Set(); 

    async function carregarDados() {
        try {
            const response = await fetch(`${API_URL}/planos-de-aula/coordenador/${matricula}`);
            if (!response.ok) throw new Error("Erro ao buscar planos");
            
            planosDaEscola = await response.json();
            renderizarTudo();

        } catch (erro) {
            console.error(erro);
            alert("Erro ao conectar com o servidor.");
        }
    }

    function renderizarTudo() {
        const tbodyNovos = document.getElementById("tabelaPlanos");
        const tbodyHist = document.getElementById("tabelaHistorico");
        
        tbodyNovos.innerHTML = "";
        tbodyHist.innerHTML = "";

        let countNovos = 0;
        let countEnviados = 0;
        let countAprovados = 0;

        planosDaEscola.forEach(plano => {
            const nomeProf = plano.nome_professor || "Prof. Desconhecido";

            if (plano.status === "EM ANÁLISE" || plano.status === "REJEITADO") {
                countNovos++;
                const isSelected = selecionados.has(plano.id);
                const btnClass = isSelected ? "btn-success" : "btn-outline-secondary";
                const btnText = isSelected ? "Incluído ✔" : "Incluir";

                const linha = `
                    <tr>
                        <td class="ps-4">
                            <strong class="text-primary">Prof. ${nomeProf}</strong>
                            <span class="text-muted small">(Matrícula: ${plano.id_professor})</span><br>
                            <span class="fw-bold text-dark">${plano.titulo}</span>
                        </td>
                        <td>${plano.id}</td>
                        <td><span class="badge bg-warning text-dark">${plano.status}</span></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm ${btnClass}" onclick="toggleSelecao(${plano.id})">
                                ${btnText}
                            </button>
                        </td>
                    </tr>
                `;
                tbodyNovos.innerHTML += linha;

            } else {
    
                if (plano.status === "ENVIADO") countEnviados++;
                if (plano.status === "APROVADO") countAprovados++;

                let badgeColor = "bg-secondary";
                if (plano.status === "ENVIADO") badgeColor = "bg-info text-dark";
                if (plano.status === "APROVADO") badgeColor = "bg-success";

                const linhaHist = `
                    <tr>
                        <td class="ps-4">
                            <strong class="text-primary">Prof. ${nomeProf}</strong><br>
                            <span class="text-dark">${plano.titulo}</span>
                        </td>
                        <td><span class="badge ${badgeColor}">${plano.status}</span></td>
                    </tr>
                `;
                tbodyHist.innerHTML += linhaHist;
            }
        });

        document.getElementById("numPlanosRecebidos").innerText = countNovos;
        document.getElementById("numEnviados").innerText = countEnviados;
        document.getElementById("numAprovados").innerText = countAprovados;

        document.getElementById("msgSemPlanos").style.display = countNovos === 0 ? "block" : "none";
        document.getElementById("msgSemHistorico").style.display = (countEnviados + countAprovados) === 0 ? "block" : "none";
    }

    function toggleSelecao(id) {
        if (selecionados.has(id)) { selecionados.delete(id); } else { selecionados.add(id); }
        renderizarTudo();
    }

    async function consolidarPedidos() {
        if (selecionados.size === 0) { alert("Selecione pelo menos um plano!"); return; }
        if (!confirm(`Confirma o envio de ${selecionados.size} planos para a Administração?`)) return;

        const payload = {
            id_coordenador: parseInt(matricula),
            planos_ids: Array.from(selecionados)
        };

        try {
            const response = await fetch(`${API_URL}/planos-de-aula/consolidar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("Planos enviados para a Administração com sucesso!");
                selecionados.clear();
                carregarDados(); 
                const tabHist = new bootstrap.Tab(document.getElementById('solic-tab'));
                tabHist.show();
            } else { 
                const erro = await response.json();
                alert("Erro ao enviar: " + (erro.detail || erro.message)); 
            }
        } catch (erro) { console.error(erro); alert("Erro de conexão."); }
    }

    carregarDados();
  </script>
</body>
</html>