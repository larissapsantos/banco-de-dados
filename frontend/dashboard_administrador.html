<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Painel Administrativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
    <div class="container-fluid px-5">
      <a class="navbar-brand fw-bold" href="#">Admin - Maker Central</a>
      <div class="d-flex align-items-center">
        <span id="usuarioLogado" class="text-white me-3">Olá, Administrador</span>
        <button id="btnSair" class="btn btn-outline-light btn-sm">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    
    <div class="row mb-5">
      <div class="col-md-4 mb-4">
        <div class="card text-center border-warning h-100">
          <div class="card-body">
            <h2 id="numPendentes" class="text-warning display-5 fw-bold">0</h2>
            <p class="mb-0">Solicitações do Meu Bairro (Pendentes)</p>
          </div>
        </div>
      </div>
      </div>

    <h4 class="fw-bold text-secondary mb-3">Solicitações Recebidas</h4>
    
    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Detalhes do Plano</th>
                <th>Status Atual</th>
                <th class="text-end pe-4">Avaliação</th>
              </tr>
            </thead>
            <tbody id="tabelaSolicitacoes">
               </tbody>
          </table>
          <div id="msgVazio" class="text-center p-5 text-muted" style="display:none;">
            Nenhuma solicitação pendente encontrada para as escolas do seu bairro.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 1. Verificação de Login
    const matricula = sessionStorage.getItem("maker_matricula");
    const perfil = sessionStorage.getItem("maker_perfil");

    if (!matricula || perfil !== "ADMINISTRADOR") {
        alert("Acesso restrito.");
        window.location.href = "login_administrador.html";
    } else {
        document.getElementById("usuarioLogado").innerText = `Olá, Admin ${matricula}`;
    }

    document.getElementById("btnSair").addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "index.html";
    });

    const API_URL = `http://localhost:8000/requisicao`;

    // 2. Carregar Planos (Filtrados por Bairro via Backend)
    async function carregarSolicitacoes() {
        const tbody = document.getElementById("tabelaSolicitacoes");
        const msgVazio = document.getElementById("msgVazio");
        const contador = document.getElementById("numPendentes");

        try {
            // Chama a rota inteligente que usa o bairro do admin
            const response = await fetch(`${API_URL}/planos-de-aula/administrador/${matricula}`);
            if (!response.ok) throw new Error("Erro ao buscar solicitações");
            
            const planos = await response.json();
            
            tbody.innerHTML = "";
            contador.innerText = planos.length;

            if (planos.length === 0) {
                msgVazio.style.display = "block";
            } else {
                msgVazio.style.display = "none";
                
                planos.forEach(plano => {
                    const linha = `
                        <tr>
                            <td class="ps-4">
                                <span class="badge bg-primary mb-1">Prof. Matrícula: ${plano.id_professor}</span>
                                <strong class="d-block text-dark">${plano.titulo}</strong>
                                <small class="text-muted">${plano.descricao}</small>
                            </td>
                            <td><span class="badge bg-info text-dark">${plano.status}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-success me-1" onclick="avaliar(${plano.id}, 'APROVADO')">Aprovar</button>
                                <button class="btn btn-sm btn-danger" onclick="avaliar(${plano.id}, 'REJEITADO')">Rejeitar</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += linha;
                });
            }
        } catch (erro) {
            console.error(erro);
            tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">Erro de conexão com o servidor.</td></tr>`;
        }
    }

    // 3. Função de Avaliar (Aprovar/Rejeitar)
    async function avaliar(id, novoStatus) {
        if(!confirm(`Confirma a alteração do status para ${novoStatus}?`)) return;

        try {
            const response = await fetch(`${API_URL}/planos-de-aula/${id}/avaliacao`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: novoStatus })
            });

            if (response.ok) {
                alert("Status atualizado com sucesso!");
                carregarSolicitacoes(); // Recarrega a tabela (o plano vai sumir pois não é mais "ENVIADO")
            } else {
                alert("Erro ao atualizar status.");
            }
        } catch (erro) {
            console.error(erro);
            alert("Erro de conexão.");
        }
    }

    // Inicia
    carregarSolicitacoes();
  </script>
</body>
</html>